Data collection
===============

The SDA App will collect events from various places in the application. All events
will be sent to Azure Table Storage.


Event format from App
---------------------
Events have the following format:

```
  {
    "ts": 1234,
    "appId": "xx",
    "userId": "yy",
    "sessId": "zz",
    "appVersion: "x.y.z",
    "location": {
      "type": "network",
      "lat": 1.11111,
      "lon": 2.2222
    },
    "eventType": "app_start",
    "eventData": "1.45"
  }
```

| Property | Rqd? | Description |
| ---------| -----|-------------|
| ts       |  y   | Timestamp the event was generated, specified as the number of milliseconds elapsed since 1 January 1970 00:00:00 UTC as returned by Javascipt's Date.now() function.|
| appId    |  y   | Unique id generated by each app installation |
| userId   |  n   | Id of the logged in user, if any |
| sessId   |  y   | Unique id for the current app session |
| appVersion   |  y   | App version. Format is MAJOR.MINOR.PATCH  |
| location |  n   | Location event was generated if available |
| type     |  n   | Type of location information. 'network' is the only type currently in use |
| lat      |  n   | Location latitude, in decimal degrees |
| lon      |  n   | Location longitude, in decimal degrees |
| eventType|  y   | The type of event. See table below for possible event types |
| eventData|  y   | The data for the event. See table below for each event's data |


The following table describes the possible event types and their data

| EventType | Fired                   | EventData             | Description |
| ----------| ------------------------|-----------------------|-------------|
| appLaunch | When the app is started | :v01.2.3:iOS:10.2.1:xxxa77c15c1-7aa6-47a2-5b62-425a1d2d384:56: | **:app version** - Released version number in the format vMAJOR.MINOR.PATCH<br>**:phone OS** - 'ios' or 'android'<br>**:OS version** - The OS version of the phone used. In the format MAJOR.MINOR.PATCH<br>**:langId** - The chosen languages unique id key. If no language is chosen langId will be 'none'<br>**:lang version** - An interger representation of a languages version number. The number increments with each new published version of a language. If no language version is selected the version number is 'none':|
| appBackground | When the app is put into the background. Either manually or due to inactivity | :: | :: |
| main | When the application is on the root of the Main tab | :: | :: |
| settings | When the application is on the root of the Settings tab | :: | :: |
| myLearning | When the application is on the root of the My learning tab | :: | :: |
| myLearningProfile | When the user interacts with the MyLearning profile settings | :action: | **:ProfileAction:** - Which action did the user perform |
| klpStart | When user starts a KeyLearningPoint test | :module\_key: | **:module\_key** - Which KLP module has started |
| klpAnswer | When the user answers a question | :module:klp\_key:question\_id:answers:clicks:score: | **:module** - Module key<br>**:klp\_key** - Key of the current key learning point<br>**:question\_id** - Which question under the KLP was answered<br>**:anwsers** - Which answer or answers where checked<br>**:clicks used** - Times the user clicked answers before anwsering.<br>**:score** - What did the user score: Is either 0 or 1 |
| klpResult | When a user finishes a My Learning test | :module:level:stars:score: | **:module** - module<br>**:level** - What level did the user finish<br>**:stars** - How many stars did the user get on this test<br>**:score:** - What score did the user get. |
| prepTestStart | When user starts a Preperation test | :module\_key: | **:module\_key** - Which module does the PrepTest belong to|
| prepTestAnswer | When the user answers a question in a PrepTest | :module:klp\_key:question\_id:answers:clicks:score: | **:module** - Module key<br>**:klp\_key** - Key of the current key learning point<br>**:question\_id** - Which question under the KLP was answered<br>**:anwsers** - Which answer or answers where checked<br>**:clicks used** - Times the user clicked answers before anwsering.<br>**:score** - What did the user score: Is either 0 or 1 |
| prepTestResult | When a user finishes a PrepTest | :module:level:stars:score: | **:module** - module<br>**:level** - What level did the user finish<br>**:stars** - How many stars did the user get on this test<br>**:score:** - What score did the user get. |
| certStart | User has started a certification test | :cert\_key: | **:cert\_key** - certificate key from CMS |
| certCase | User reads case text  | :cert\_key:case\_key: | **:cert\_key** - certificate key from CMS<br>**:case\_key** - Case key |
| certAnswer | User answers certification question  | :cert\_key:case\_key:question\_key:score:answers:clicks:current\_deadly | **:cert\_key** - certificate key from CMS<br>**:case\_key** - Case key<br>**:question\_key** - question id<br>**:score** - What the user scored on this question. Max is 1 for complete correct answer while -1 is lowest for deadly<br>**:answers** - What did the user anwser<br>**:clicks used** - Times the user clicked answers before anwsering. <br>**:current\_deadly** - How many deadly answers the user has so far
| certDone | User finished certification test  | :cert\_key:score:max\_score:score\_percent:pass\_rate:passed:deadly\_answers:deadlies\_to\_fail | **:cert\_key** - Certificate key<br>**:score** - How many points did the user score<br>**:max\_score** - What is possible max score<br>**:score\_percent** - User's score percentage<br>**:pass\_rate** - Certificate pass rate<br>**:passed** - Did the user pass or not <br>**:deadly\_answers** - How many deadly answers the user gave <br>**:deadly\_to\_fail** - Number of deadly answers that will result in a failed certificate
| certClaimed | User claimed the certificate  | :cert\_key: | **:cert\_key** - Certificate key |
| druglist | When the druglist is displayed.| :all: | **:listType** - Contains information on the type of list. Either 'all' or 'specified. 'all' is the displayed if there is no specified druglist avaliable: |
| changeDruglistFilterÂ | When a user tabs/swipes between all drugs and specified drugs | :all: | **:listType** - Contains information on the type of list the user switched to. Either 'all' or 'specified': |
| drug | When a drug is displayed | :adrenaline\_1486111274533: | **:drugKey** - in the format [drug]\_[timestamp]. Timestamp added to make key unique: |
| module | When a module is shown | :manual-removal-of-placenta\_1487678949720: | **:moduleKey:** moduleKey - in the format [module]\_[timestamp]. Timestamp added to make key unique. Alternativly users with older language version, will have a moduleKey represented by an UID. This was changed to make the key more humanly readable. Mapping between old moduleKeys and their names can be found at: https://trello-attachments.s3.amazonaws.com/57cd98c36e64f5a368c9ec08/595d46525b85c542a15d44d5/b47a78aee76677403e0e97b78589cb8a/keys.json |
| upq | When navigating to a UPQ-page | :question\_1: | **:questionKey** - key of the user profile question shown: |
| answerUpq | User answered a upq | :upq:question\_3:upq:question\_3\_answer\_2: | **:questionKey** - key of the user profile question shown<br>**:answerKey** - key of the chosen answer to a user profile question: |
| actioncardList | When app shows list of avaliable actioncards in a module | :: | :: |
| procedureList | When app shows list of avaliable procedures in a module | :: | :: |
| chapterList | When app shows the chapter list for an actioncard or procedure, if they have more than one | :mixing-chlorine-solution\_148724580781: | **:itemKey** - the key represents either an actioncard or a procedure in the format [actioncard/procedure]\_[timestamp]. Timestamp added to make key unique: |
| actioncard | When a specific actioncard is displayed | :mixing-alcohol-based-handrub\_1487245431108:0:\_1472454422011: | **:itemKey** - the key represents an actioncard in the format [actioncard]\_[timestamp]. Timestamp added to make key unique.<br>**:chapterIndex** - Index shows which chapter of the actioncard is displayed. This value should always be an integer. The index indicates the position of the chapter in the chapterList, starting with 0 for the first chapter.<br>**:chapterkey** - the chapters unique identifier in the format [chapter-name]\_[timestamp]. Alot of the chapters have no name in the key (\_[timestamp]). Which makes them more difficult to read. The lack of name comes from them not having a blank name in the CMS. This is manually set by Maternity, when they create chapters in master so there is no coded rules, but as it is used now blank names generally mean that there is only one chapter. chapterKey was added in version 3.0.8, so data from earlier versions will not have this property|
| actioncardCompletion | HappyBirthday feature. Indicate checkbox in actioncard | :babc-session-answers-\_1591948808481:0:session-1\_1591949830753:organized: | **:itemKey** - actioncard in the format [actioncard]\_[timestamp]. <br>**:chapterIndex**<br>**:chapterkey** - chapter in format [chapter-name]\_[timestamp]. <br>**:completion type** - organized or informally|
| procedure | When a procedure is displayed | :mixing-alcohol-based-handrub\_1487245431108:0: | **:itemKey** - the key represents a procedure in the format [procedure]\_[timestamp]. Timestamp added to make key unique:chapterIndex - Index shows which chapter of the procedure is displayed. This value should always be an integer. The index indicates the position of the chapter in the chapterList, starting with 0 for the first chapter.<br>**:chapterkey** - the chapters unique identifier in the format [chapter-name]\_[timestamp]. Alot of the chapters have no name in the key (_[timestamp]). Which makes them more difficult to read. The lack of name comes from them not having a blank name in the CMS. This is manually set by Maternity, when they create chapters in master. As it is used now blank names mean that there is only one chapter. chapterKey was added in version 3.0.8, so data from earlier versions will not have this property. |
| setting | When a settings option is displayed | :thankyou:0: | **:itemKey** - the key represents a procedure in the format [setting]\_[timestamp]. Timestamp added to make key unique.<br>**:chapterIndex** - Index shows which chapter of the setting is displayed. This value should always be an integer. The index indicates the position of the chapter in the chapterList, starting with 0 for the first chapter: chapterkey - the chapters unique identifier in the format [chapter-name]\_[timestamp].|
| chooseVersionList | When the list of the avaliable versions is shown. Tracks which index file the list is based on | :1491304981592: | **:indexVersion** - the version of the index file. Version number is identical to the timestamp of the time the index was published from the CMS. Earlier index versions are not stored in the database for reference: |
| versionChosen | Called when a version is selected by the user | :7cf6efab-a9d7-54d2-2cbd-ec82efe4a7da:67: | **:languageId** - the id of the chosen language. It is not possible to see from the id wether the language was published for production or as a draft<br>**:version** - the version of the chosen language version: |
| terms | When the initial terms of use is shown | :: | :: |
| acceptTerms | When the terms of use is accepted | :: | :: |
| notificationMessage | When the notification dialog is shown in the application | :did-you-know-you-can-get-a-better-overview-of-a-perineal-trauma-by-packing-the-vagina-with-gauze-_1489052022462:| **:notificationKey** - derived from the notification text in the format [notification-text]\_[timestamp]. Timestamp added to make key unique: |
| welcome | Welcome screen is shown | :: | :: |
| videoList | When the application shows the video and a list of its subchapters | :: |Â :: |
| videoFull | When the application plays the full video for a module | :: | :: |
| videoChapter | When the application plays a specific chapter from the modules video |:/english WHO/Infection prevention/intro: | **:video chapter** - the key of the video chapter played. The key is derived from the structure of video assets on the server in the format /[language version]/[module]/[video chapter]: |
| assetsLoading | When an Android apk with a pre-build language version do its initial setup. | :: | ::Â |
| onboarding | Part of the applications onboarding flow | :improve_skills: | Current screen in the onboarding flow. One of: "user\_profile\_questions, know-how, terms\_of\_use, improve\_skills, access\_drug\_list, background\_survey, survey\_intro |
| handleLink | When the application picks up a link starting with safedelivery:// |Â :url: |
| finishedLinkNavigation | When completed all route and dispatch events connected with linking | :invalidUrl: | **:error_message** - specified if link did not work. Default is invalidUrl meaning the application could not understand the link given. The others are "notInModule" (the video/drug/pp/ac is not included in the module specified), "moduleNotInLanguage" (language does not have specified module), "langaugeNotAvaliable" (missing or corrupted active language), "invalidAppState (app state actively blocks linking), "noProfile" (no active user on MyLearning): |
| pressedLink | The user clicked a link in sda content | :internal: | :url - the link pressed:linkType - if the link was an internal or external link |
| externalLinkWarning |Â The users respons to leaving the application for an external link |Â :accept: | :response - either accept or declineÂ |



Backend API for events
----------------------
Events are POSTed to the URL ```https://sda.maternity.dk/api/public/events```

The body should be an array of app events in JSON format.

It is ok for a single POST request to contain identical ```ts``` values, but separate requests
should have unique ```ts``` values.

The following HTTP codes can be returned

| Code | Description                                                                       |
|------|-----------------------------------------------------------------------------------|
| 200  | All events were stored |
| 400  | There was a problem with the data, either invalid JSON format or missing properties |
| 500  | Something unexpected happened |

There's no reason in retrying the operation when a 400 is returned. A 500 code _may\_ indicate a temporary failure
on e.g. Azure so it may make sense to retry the operation later.

Event storage in Azure
----------------------
Events are stored in Azure Table Storage. The appId is used as PartitionKey and
ts + event index is used as RowKey.

A Timestamp is automatically added for each row.


Events in SQL Server
--------------------
Events are copied from Table Storage to a SQL Server instance every hour by an Azure Data Factory
pipeline.

The SQL Server table has the following format

```
CREATE TABLE DevEvents (
  PartitionKey NVARCHAR(32) NOT NULL ,
  RowKey NVARCHAR(32) NOT NULL ,
  ServerTime DATETIMEOFFSET NOT NULL,
  EventTime DATETIMEOFFSET NOT NULL ,
  AppId NVARCHAR(32) NOT NULL ,
  SessId NVARCHAR(32) NOT NULL,
  UserId NVARCHAR(32),
  EventType NVARCHAR(256) NOT NULL,
  EventData NVARCHAR(1024) NOT NULL,
  LocType NVARCHAR(32),
  Lat DOUBLE PRECISION,
  Lon DOUBLE PRECISION,
  Slice BINARY(32)
)
```
The slice column is used by the ADF pipeline to manage incremental updates and can be ignored.
